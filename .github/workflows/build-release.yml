name: Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_release:
        description: "Skip publishing release (build only)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  NODE_VERSION: "20.x"

jobs:
  # ============================================
  # Job 1: Prepare - Get version, check release
  # ============================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
      version_tag: ${{ steps.get_version.outputs.VERSION_TAG }}
      should_release: ${{ steps.check_release.outputs.should_release }}

    steps:
      - uses: actions/checkout@v6

      - name: Setup NodeJS
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -pe "require('./electron/package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_TAG=v$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: v$VERSION"

      - name: Check if should release
        id: check_release
        run: |
          VERSION_TAG="${{ steps.get_version.outputs.VERSION_TAG }}"
          if git rev-parse "refs/tags/$VERSION_TAG" >/dev/null 2>&1; then
            echo "âš ï¸ Tag $VERSION_TAG already exists"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Tag $VERSION_TAG does not exist, will release"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Delete existing draft release
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          VERSION_TAG="${{ steps.get_version.outputs.VERSION_TAG }}"
          echo "ðŸ—‚ï¸ Checking for existing draft release: $VERSION_TAG"

          # Delete existing draft release if exists
          gh release delete "$VERSION_TAG" --yes 2>/dev/null || true

          # Also delete any draft releases with same tag
          DRAFT_RELEASES=$(gh release list --limit 10 --json tagName,isDraft -q '.[] | select(.isDraft) | .tagName' 2>/dev/null || echo "")
          for tag in $DRAFT_RELEASES; do
            if [ "$tag" = "$VERSION_TAG" ]; then
              echo "ðŸ—‘ï¸ Deleting draft: $tag"
              gh release delete "$tag" --yes || true
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  # ============================================
  # Job 2: Build all platforms in parallel
  # Using matrix strategy for efficiency
  # ============================================
  build:
    name: Build ${{ matrix.name }}
    needs: prepare
    if: needs.prepare.outputs.should_release == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM64 (Apple Silicon)
          - name: macOS-arm64
            os: macos-15
            platform: mac
            arch: arm64
            artifact_name: mac-arm64

          # macOS x64 (Intel) - Cross-compile on ARM64
          - name: macOS-x64
            os: macos-15
            platform: mac
            arch: x64
            artifact_name: mac-x64

          # Windows x64
          - name: Windows-x64
            os: windows-latest
            platform: win
            arch: x64
            artifact_name: windows

          # Linux x64
          - name: Linux-x64
            os: ubuntu-latest
            platform: linux
            arch: x64
            artifact_name: linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup NodeJS
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "./electron/package-lock.json"

      - name: Install dependencies
        working-directory: ./electron
        shell: bash
        run: |
          rm -rf node_modules
          npm ci

      # ========== macOS specific steps ==========
      - name: Setup macOS native modules
        if: matrix.platform == 'mac'
        working-directory: ./electron
        env:
          npm_config_arch: ${{ matrix.arch }}
          npm_config_target_arch: ${{ matrix.arch }}
        run: |
          echo "ðŸ”§ Setting up native modules for macOS ${{ matrix.arch }}..."

          # Remove existing sharp and reinstall for target arch
          npm uninstall sharp || true
          npm install --cpu=${{ matrix.arch }} --os=darwin sharp

          # Rebuild native modules for target architecture
          npx @electron/rebuild -f -w better-sqlite3 --arch=${{ matrix.arch }}
          npx @electron/rebuild -f -w sharp --arch=${{ matrix.arch }}

      # ========== Build steps ==========
      - name: Build Electron app
        working-directory: ./electron
        shell: bash
        run: npm run build

      - name: Package application
        working-directory: ./electron
        shell: bash
        env:
          npm_config_arch: ${{ matrix.arch }}
        run: |
          echo "ðŸ“¦ Packaging for ${{ matrix.platform }} ${{ matrix.arch }}..."

          # Build command varies by platform
          # macOS supports --arm64 and --x64 flags
          # Windows and Linux don't need arch flag (builds for runner's arch)
          if [ "${{ matrix.platform }}" = "mac" ]; then
            npx electron-builder --mac --${{ matrix.arch }} --publish never
          else
            npx electron-builder --${{ matrix.platform }} --publish never
          fi

      - name: List built files
        working-directory: ./electron
        shell: bash
        run: |
          echo "ðŸ“¦ Built files:"
          ls -la release/ || true

      # ========== Upload artifacts ==========
      - name: Upload macOS artifacts
        if: matrix.platform == 'mac'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            electron/release/*.dmg
            electron/release/*.zip
            electron/release/*.blockmap
            electron/release/latest-mac.yml
          retention-days: 1
          if-no-files-found: error

      - name: Upload Windows artifacts
        if: matrix.platform == 'win'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            electron/release/*.exe
            electron/release/*.blockmap
            electron/release/latest.yml
          retention-days: 1
          if-no-files-found: error

      - name: Upload Linux artifacts
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            electron/release/*.AppImage
            electron/release/*.deb
            electron/release/latest-linux.yml
          retention-days: 1
          if-no-files-found: warn

  # ============================================
  # Job 3: Create Release & Upload All Assets
  # ============================================
  release:
    name: Publish Release
    needs: [prepare, build]
    if: |
      always() && 
      needs.prepare.outputs.should_release == 'true' &&
      needs.build.result == 'success'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      VERSION_TAG: ${{ needs.prepare.outputs.version_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Downloaded artifacts:"
          find artifacts -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.zip" -o -name "*.blockmap" \) 2>/dev/null | sort
          echo ""
          ls -laR artifacts/ 2>/dev/null | head -100

      - name: Prepare release files
        run: |
          mkdir -p release-files
          VERSION="${{ env.VERSION }}"

          echo "ðŸ“¦ Collecting release files for version $VERSION..."

          # Copy all artifacts to release-files (including yml files generated by electron-builder)
          find artifacts -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.zip" -o -name "*.blockmap" -o -name "latest*.yml" \) -exec cp {} release-files/ \;

          echo ""
          echo "ðŸ“‹ Final release files:"
          ls -la release-files/

      - name: Generate changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          echo "ðŸ“‹ Generating changelog..."
          echo "Previous tag: $PREV_TAG"

          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" $PREV_TAG..HEAD --no-merges | head -50)
          else
            CHANGELOG=$(git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" -20 --no-merges)
          fi

          echo "$CHANGELOG" > /tmp/changelog.txt

          {
            echo 'CHANGELOG<<EOF'
            cat /tmp/changelog.txt
            echo 'EOF'
          } >> $GITHUB_ENV

          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: ${{ env.VERSION_TAG }}
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            ## ðŸš€ Remote Time Tracker ${{ env.VERSION_TAG }}

            ### ðŸ“ What's Changed
            ${{ env.CHANGELOG }}

            ### ðŸ“¥ Downloads

            | Platform | Architecture | File |
            |----------|--------------|------|
            | **Windows** | x64 | `Remote Time Tracker Setup ${{ env.VERSION }}.exe` |
            | **macOS** | Apple Silicon (M1/M2/M3) | `Remote Time Tracker-${{ env.VERSION }}-arm64.dmg` |
            | **macOS** | Intel | `Remote Time Tracker-${{ env.VERSION }}-x64.dmg` |
            | **Linux** | x64 | `Remote Time Tracker-${{ env.VERSION }}.AppImage` |

            ### ðŸ”„ Auto-Update
            Existing installations will automatically update to this version.

            ### ðŸ™ Thanks
            Thanks to all contributors! ðŸ…

            ---
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ env.PREV_TAG }}...${{ env.VERSION_TAG }}
          files: |
            release-files/*.dmg
            release-files/*.exe
            release-files/*.AppImage
            release-files/*.deb
            release-files/*.zip
            release-files/*.blockmap
            release-files/latest*.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Release summary
        if: always()
        run: |
          echo "## ðŸ“Š Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ env.VERSION_TAG }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Result | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Release Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la release-files/ 2>/dev/null || echo "No files"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
