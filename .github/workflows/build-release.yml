name: Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_release:
        description: "Skip publishing release (build only)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  NODE_VERSION: "20.x"

jobs:
  # ============================================
  # Job 1: Prepare - Get version, check release
  # ============================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
      version_tag: ${{ steps.get_version.outputs.VERSION_TAG }}
      should_release: ${{ steps.check_release.outputs.should_release }}

    steps:
      - uses: actions/checkout@v6

      - name: Setup NodeJS
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -pe "require('./electron/package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_TAG=v$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: v$VERSION"

      - name: Check if should release
        id: check_release
        run: |
          VERSION_TAG="${{ steps.get_version.outputs.VERSION_TAG }}"
          if git rev-parse "refs/tags/$VERSION_TAG" >/dev/null 2>&1; then
            echo "âš ï¸ Tag $VERSION_TAG already exists"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Tag $VERSION_TAG does not exist, will release"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Delete existing draft release
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          VERSION_TAG="${{ steps.get_version.outputs.VERSION_TAG }}"
          echo "ðŸ—‚ï¸ Checking for existing draft release: $VERSION_TAG"

          # Delete existing draft release if exists
          gh release delete "$VERSION_TAG" --yes 2>/dev/null || true

          # Also delete any draft releases with same tag
          DRAFT_RELEASES=$(gh release list --limit 10 --json tagName,isDraft -q '.[] | select(.isDraft) | .tagName' 2>/dev/null || echo "")
          for tag in $DRAFT_RELEASES; do
            if [ "$tag" = "$VERSION_TAG" ]; then
              echo "ðŸ—‘ï¸ Deleting draft: $tag"
              gh release delete "$tag" --yes || true
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  # ============================================
  # Job 2: Build all platforms in parallel
  # Using matrix strategy for efficiency
  # ============================================
  build:
    name: Build ${{ matrix.name }}
    needs: prepare
    if: needs.prepare.outputs.should_release == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM64 (Apple Silicon)
          - name: macOS-arm64
            os: macos-15
            platform: mac
            arch: arm64
            artifact_name: mac-arm64

          # macOS x64 (Intel) - Cross-compile on ARM64
          - name: macOS-x64
            os: macos-15
            platform: mac
            arch: x64
            artifact_name: mac-x64

          # Windows
          - name: Windows
            os: windows-latest
            platform: win
            artifact_name: windows

          # Linux
          - name: Linux
            os: ubuntu-latest
            platform: linux
            artifact_name: linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup NodeJS
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "./electron/package-lock.json"

      - name: Install dependencies
        working-directory: ./electron
        shell: bash
        run: |
          rm -rf node_modules
          npm ci

      # ========== macOS specific steps ==========
      - name: Setup macOS native modules
        if: matrix.platform == 'mac'
        working-directory: ./electron
        env:
          npm_config_arch: ${{ matrix.arch }}
          npm_config_target_arch: ${{ matrix.arch }}
        run: |
          echo "ðŸ”§ Setting up native modules for macOS ${{ matrix.arch }}..."

          # Remove existing sharp and reinstall for target arch
          npm uninstall sharp || true
          npm install --cpu=${{ matrix.arch }} --os=darwin sharp

          # Rebuild native modules for target architecture
          npx @electron/rebuild -f -w better-sqlite3 --arch=${{ matrix.arch }}
          npx @electron/rebuild -f -w sharp --arch=${{ matrix.arch }}

      # ========== Build steps ==========
      - name: Build Electron app
        working-directory: ./electron
        shell: bash
        run: npm run build

      - name: Package application
        working-directory: ./electron
        shell: bash
        run: |
          echo "ðŸ“¦ Packaging for ${{ matrix.platform }}..."

          # Build command varies by platform
          # macOS needs explicit --arm64 or --x64 flag
          # Windows and Linux build for runner's native architecture
          if [ "${{ matrix.platform }}" = "mac" ]; then
            npm_config_arch=${{ matrix.arch }} npx electron-builder --mac --${{ matrix.arch }} --publish never
          else
            npx electron-builder --${{ matrix.platform }} --publish never
          fi

      - name: List built files
        working-directory: ./electron
        shell: bash
        run: |
          echo "ðŸ“¦ Built files:"
          ls -la release/ || true

      # Rename latest-mac.yml to include architecture to avoid overwrite
      - name: Rename latest-mac.yml for architecture
        if: matrix.platform == 'mac'
        working-directory: ./electron
        run: |
          if [ -f release/latest-mac.yml ]; then
            mv release/latest-mac.yml release/latest-mac-${{ matrix.arch }}.yml
            echo "âœ… Renamed to latest-mac-${{ matrix.arch }}.yml"
          fi

      # ========== Upload artifacts ==========
      - name: Upload macOS artifacts
        if: matrix.platform == 'mac'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            electron/release/*.dmg
            electron/release/*.zip
            electron/release/*.blockmap
            electron/release/latest-mac-${{ matrix.arch }}.yml
          retention-days: 1
          if-no-files-found: error

      - name: Upload Windows artifacts
        if: matrix.platform == 'win'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            electron/release/*.exe
            electron/release/*.blockmap
            electron/release/latest.yml
          retention-days: 1
          if-no-files-found: error

      - name: Upload Linux artifacts
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            electron/release/*.AppImage
            electron/release/*.deb
            electron/release/latest-linux.yml
          retention-days: 1
          if-no-files-found: warn

  # ============================================
  # Job 3: Create Release & Upload All Assets
  # ============================================
  release:
    name: Publish Release
    needs: [prepare, build]
    if: |
      always() && 
      needs.prepare.outputs.should_release == 'true' &&
      needs.build.result == 'success'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      VERSION_TAG: ${{ needs.prepare.outputs.version_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Downloaded artifacts:"
          find artifacts -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.zip" -o -name "*.blockmap" \) 2>/dev/null | sort
          echo ""
          ls -laR artifacts/ 2>/dev/null | head -100

      - name: Prepare release files
        run: |
          mkdir -p release-files
          VERSION="${{ env.VERSION }}"

          echo "ðŸ“¦ Collecting release files for version $VERSION..."

          # Copy all artifacts to release-files (excluding latest-mac-*.yml which will be merged)
          find artifacts -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.zip" -o -name "*.blockmap" -o -name "latest.yml" -o -name "latest-linux.yml" \) -exec cp {} release-files/ \;

          echo ""
          echo "ðŸ“‹ Final release files:"
          ls -la release-files/

      - name: Merge macOS latest-mac.yml files
        run: |
          echo "ðŸ”€ Merging macOS latest-mac.yml files..."

          # Find the architecture-specific yml files
          ARM64_YML=$(find artifacts -name "latest-mac-arm64.yml" -type f | head -1)
          X64_YML=$(find artifacts -name "latest-mac-x64.yml" -type f | head -1)

          echo "ARM64 file: $ARM64_YML"
          echo "X64 file: $X64_YML"

          # Create merged latest-mac.yml using shell
          if [ -n "$ARM64_YML" ] && [ -n "$X64_YML" ]; then
            echo "âœ… Found both architecture files, merging..."
            
            # Debug: show content of both files
            echo "--- ARM64 content ---"
            cat "$ARM64_YML"
            echo ""
            echo "--- X64 content ---"
            cat "$X64_YML"
            echo ""
            
            # Extract metadata from arm64 file
            VERSION=$(grep "^version:" "$ARM64_YML")
            RELEASE_DATE=$(grep "^releaseDate:" "$ARM64_YML")
            PATH_LINE=$(grep "^path:" "$ARM64_YML")
            SHA512_LINE=$(grep "^sha512:" "$ARM64_YML" | head -1)
            
            # Extract files entries - lines starting with "  " (2 spaces) after "files:" line
            # Using grep with line numbers to find files section, then filter
            ARM64_FILES=$(awk '/^files:/{found=1; next} /^[a-zA-Z]/{found=0} found && /^  /' "$ARM64_YML")
            X64_FILES=$(awk '/^files:/{found=1; next} /^[a-zA-Z]/{found=0} found && /^  /' "$X64_YML")
            
            # Build merged file
            {
              echo "$VERSION"
              echo "files:"
              echo "$ARM64_FILES"
              echo "$X64_FILES"
              echo "$PATH_LINE"
              echo "$SHA512_LINE"
              echo "$RELEASE_DATE"
            } > release-files/latest-mac.yml
            
            # Validate the merged file
            echo ""
            echo "ðŸ“‹ Merged latest-mac.yml content:"
            cat release-files/latest-mac.yml
            
            # Count files entries to verify merge
            FILE_COUNT=$(grep -c "^  - url:" release-files/latest-mac.yml || echo "0")
            echo ""
            echo "âœ… Total file entries: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -lt 2 ]; then
              echo "âš ï¸ Warning: Expected at least 2 file entries but got $FILE_COUNT"
              echo "Falling back to arm64 file only..."
              cp "$ARM64_YML" release-files/latest-mac.yml
            fi
            
          elif [ -n "$ARM64_YML" ]; then
            echo "âš ï¸ Only ARM64 file found, using it directly"
            cp "$ARM64_YML" release-files/latest-mac.yml
          elif [ -n "$X64_YML" ]; then
            echo "âš ï¸ Only x64 file found, using it directly"
            cp "$X64_YML" release-files/latest-mac.yml
          else
            echo "âŒ No macOS yml files found!"
            exit 1
          fi

          echo ""
          echo "ðŸ“‹ All release files:"
          ls -la release-files/

      - name: Generate changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          echo "ðŸ“‹ Generating changelog..."
          echo "Previous tag: $PREV_TAG"

          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" $PREV_TAG..HEAD --no-merges | head -50)
          else
            CHANGELOG=$(git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" -20 --no-merges)
          fi

          echo "$CHANGELOG" > /tmp/changelog.txt

          {
            echo 'CHANGELOG<<EOF'
            cat /tmp/changelog.txt
            echo 'EOF'
          } >> $GITHUB_ENV

          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: ${{ env.VERSION_TAG }}
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            ## ðŸš€ Remote Time Tracker ${{ env.VERSION_TAG }}

            ### ðŸ“ What's Changed
            ${{ env.CHANGELOG }}

            ### ðŸ“¥ Downloads

            | Platform | Type | File |
            |----------|------|------|
            | **Windows** | Installer | `Remote Time Tracker Setup ${{ env.VERSION }}.exe` |
            | **Windows** | Portable | `Remote Time Tracker ${{ env.VERSION }}.exe` |
            | **macOS** | Apple Silicon (M1/M2/M3) | `Remote Time Tracker-${{ env.VERSION }}-arm64.dmg` |
            | **macOS** | Intel (x64) | `Remote Time Tracker-${{ env.VERSION }}-x64.dmg` |
            | **Linux** | AppImage | `Remote Time Tracker-${{ env.VERSION }}.AppImage` |
            | **Linux** | Debian | `Remote Time Tracker-${{ env.VERSION }}.deb` |

            ### ðŸ”„ Auto-Update
            Existing installations will automatically update to this version.

            ### ðŸ™ Thanks
            Thanks to all contributors! ðŸ…

            ---
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ env.PREV_TAG }}...${{ env.VERSION_TAG }}
          files: |
            release-files/*.dmg
            release-files/*.exe
            release-files/*.AppImage
            release-files/*.deb
            release-files/*.zip
            release-files/*.blockmap
            release-files/latest*.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Release summary
        if: always()
        run: |
          echo "## ðŸ“Š Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ env.VERSION_TAG }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Result | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Release Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la release-files/ 2>/dev/null || echo "No files"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
