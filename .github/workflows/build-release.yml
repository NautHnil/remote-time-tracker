name: Build and Release

on:
  push:
    branches: [main]

permissions:
  contents: write

env:
  NODE_VERSION: "20.x"

jobs:
  prepare:
    name: Prepare version & clean release
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
      version_tag: ${{ steps.get_version.outputs.VERSION_TAG }}

    steps:
      - uses: actions/checkout@v5

      - name: Setup NodeJS
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -pe "require('./electron/package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_TAG=v$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: v$VERSION"

      - name: Delete existing release assets (all)
        run: |
          set -e
          VERSION_TAG="${{ steps.get_version.outputs.VERSION_TAG }}"
          echo "üóÇÔ∏è Version tag: $VERSION_TAG"
          RELEASE_ID=$(gh release view "$VERSION_TAG" --json id -q ".id" 2>/dev/null || echo "")
          if [ -n "$RELEASE_ID" ]; then
            echo "üóëÔ∏è Found release ID $RELEASE_ID, deleting all assets..."
            mapfile -t ASSET_IDS < <(gh release view "$VERSION_TAG" --json assets -q ".assets[].id")
            if [ ${#ASSET_IDS[@]} -gt 0 ]; then
              for ASSET_ID in "${ASSET_IDS[@]}"; do
                echo "Deleting asset $ASSET_ID"
                gh release delete-asset "$VERSION_TAG" "$ASSET_ID"
              done
            else
              echo "No assets found, skipping delete"
            fi
          else
            echo "‚ÑπÔ∏è Release for tag $VERSION_TAG not found, skipping delete"
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  build:
    if: github.event.pull_request.draft == false
    name: Build Desktop App
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup NodeJS
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "./electron/package-lock.json"

      - name: Install dependencies
        working-directory: ./electron
        shell: bash
        run: |
          rm -rf node_modules
          npm ci

      - name: Rebuild native modules
        if: startsWith(matrix.os, 'macos') && github.event_name != 'pull_request'
        working-directory: ./electron
        run: npm run rebuild

      # Build and release if it's push to main branch
      - name: Build and release on macOS
        if: startsWith(matrix.os, 'macos') && github.event_name != 'pull_request'
        working-directory: ./electron
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: npm run release:mac

      - name: Build and release on Linux
        if: startsWith(matrix.os, 'ubuntu') && github.event_name != 'pull_request'
        working-directory: ./electron
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: npm run release:linux

      - name: Build and release on Windows
        if: startsWith(matrix.os, 'windows') && github.event_name != 'pull_request'
        working-directory: ./electron
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: npm run release:win

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      VERSION_TAG: ${{ needs.prepare.outputs.version_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup NodeJS
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check if version tag already exists
        run: |
          VERSION_HASH=$(git rev-parse -q --verify "refs/tags/${{ env.VERSION_TAG }}" || echo "")
          echo "VERSION_HASH=$VERSION_HASH" >> $GITHUB_ENV
          if [ -n "$VERSION_HASH" ]; then
            echo "‚ö†Ô∏è Tag ${{ env.VERSION_TAG }} already exists, skipping release"
          else
            echo "‚úÖ Tag ${{ env.VERSION_TAG }} does not exist, proceeding with release"
          fi

      - name: Wait for assets to be uploaded
        if: env.VERSION_HASH == ''
        run: |
          echo "‚è≥ Waiting 30 seconds for all assets to be uploaded..."
          sleep 30

      - name: Fetch draft release
        if: env.VERSION_HASH == ''
        uses: cardinalby/git-get-release-action@v1
        id: get_draft_release
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          latest: true
          draft: true
          searchLimit: 5

      - name: Generate changelog
        if: env.VERSION_HASH == '' && steps.get_draft_release.outputs.id != ''
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          echo "üìã Generating changelog..."
          echo "Previous tag: $PREV_TAG"

          if [ -n "$PREV_TAG" ]; then
            # Get commits since last tag
            CHANGELOG=$(git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" $PREV_TAG..HEAD --no-merges)
          else
            # Get last 20 commits if no previous tag
            CHANGELOG=$(git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" -20 --no-merges)
          fi

          # Save changelog to file for multiline output
          echo "$CHANGELOG" > /tmp/changelog.txt

          # Use delimiter for multiline output
          {
            echo 'CHANGELOG<<EOF'
            cat /tmp/changelog.txt
            echo 'EOF'
          } >> $GITHUB_ENV

          echo "‚úÖ Changelog generated"

      - name: Publish Release
        if: env.VERSION_HASH == '' && steps.get_draft_release.outputs.id != ''
        uses: irongut/EditRelease@v1.2.0
        with:
          token: ${{ secrets.GH_TOKEN }}
          id: ${{ steps.get_draft_release.outputs.id }}
          draft: false
          prerelease: false
          replacename: true
          replacebody: true
          name: ${{ env.VERSION_TAG }}
          body: |
            ## üöÄ Remote Time Tracker ${{ env.VERSION_TAG }}

            ### üìù What's Changed
            ${{ env.CHANGELOG }}

            ### üì• Downloads
            - **Windows**: `Remote Time Tracker Setup ${{ steps.get_version.outputs.VERSION }}.exe` (Installer) or `Remote Time Tracker ${{ steps.get_version.outputs.VERSION }}.exe` (Portable)
            - **macOS (Apple Silicon)**: `Remote Time Tracker-${{ steps.get_version.outputs.VERSION }}-arm64.dmg`
            - **macOS (Intel)**: `Remote Time Tracker-${{ steps.get_version.outputs.VERSION }}-x64.dmg`
            - **Linux**: `Remote Time Tracker-${{ steps.get_version.outputs.VERSION }}.AppImage` or `.deb`

            ### üôè Thanks
            Thanks to all contributors! üèÖ

            ---
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ env.PREV_TAG }}...${{ env.VERSION_TAG }}

      - name: Release summary
        if: always()
        run: |
          echo "## üìä Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ env.VERSION_TAG }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag Exists | ${{ env.VERSION_HASH != '' && '‚úÖ Yes' || '‚ùå No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Draft Release ID | ${{ steps.get_draft_release.outputs.id || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
